# builds a standalone single-site wrapper ipa.
# trigger manually from the actions tab and fill in the site details.
# uses xcodegen to generate the xcode project, then builds an unsigned
# ipa ready for sideloading.

name: build site wrapper ipa

on:
  workflow_dispatch:
    inputs:
      site_name:
        description: "app display name"
        required: true
        type: string
      site_url:
        description: "website url to wrap"
        required: true
        type: string
      bundle_id:
        description: "bundle identifier (leave empty for auto)"
        required: false
        default: ""
        type: string
      orientation:
        description: "orientation lock"
        required: false
        default: "automatic"
        type: choice
        options:
          - automatic
          - portrait
          - landscape
      enable_javascript:
        description: "enable javascript"
        required: false
        default: true
        type: boolean
      enable_stikjit:
        description: "enable stikjit"
        required: false
        default: false
        type: boolean
      enable_fullscreen:
        description: "full screen mode"
        required: false
        default: false
        type: boolean
      user_agent:
        description: "custom user agent (leave empty for default)"
        required: false
        default: ""
        type: string

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: select xcode version
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          if [ -z "$XCODE_PATH" ]; then
            echo "error: no xcode installation found"
            exit 1
          fi
          echo "using: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"

      - name: show xcode version
        run: xcodebuild -version

      - name: install xcodegen
        run: brew install xcodegen

      # compute safe bundle id from the site name
      - name: resolve bundle id
        id: ids
        run: |
          SAFE_NAME=$(echo "${{ inputs.site_name }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
          BUNDLE_ID="${{ inputs.bundle_id }}"
          if [ -z "$BUNDLE_ID" ]; then
            BUNDLE_ID="com.beryllium.wrap.${SAFE_NAME}"
          fi
          echo "safe_name=${SAFE_NAME}" >> "$GITHUB_OUTPUT"
          echo "bundle_id=${BUNDLE_ID}" >> "$GITHUB_OUTPUT"

      # generate a minimal swift app and xcodegen project for this single site
      - name: generate site wrapper project
        run: |
          mkdir -p SiteWrapper/Assets.xcassets/AppIcon.appiconset

          # asset catalog contents
          echo '{"info":{"author":"xcode","version":1}}' > SiteWrapper/Assets.xcassets/Contents.json
          echo '{"images":[{"idiom":"universal","platform":"ios","size":"1024x1024"}],"info":{"author":"xcode","version":1}}' > SiteWrapper/Assets.xcassets/AppIcon.appiconset/Contents.json

          # orientation swift value
          ORIENTATION_MASK=".all"
          if [ "${{ inputs.orientation }}" = "portrait" ]; then
            ORIENTATION_MASK=".portrait"
          elif [ "${{ inputs.orientation }}" = "landscape" ]; then
            ORIENTATION_MASK=".landscape"
          fi

          # fullscreen swift values
          IGNORE_SAFE_AREA=".init()"
          STATUS_BAR_HIDDEN="false"
          if [ "${{ inputs.enable_fullscreen }}" = "true" ]; then
            IGNORE_SAFE_AREA=".all"
            STATUS_BAR_HIDDEN="true"
          fi

          # write the single swift source file
          cat > SiteWrapper/SiteWrapperApp.swift << 'SWIFTEOF'
          // auto-generated by beryllium ci pipeline
          import SwiftUI
          import WebKit

          @main
          struct SiteWrapperApp: App {
              var body: some Scene {
                  WindowGroup {
                      WrappedWebView()
                          .ignoresSafeArea(IGNORE_SAFE_AREA_PLACEHOLDER)
                          .statusBarHidden(STATUS_BAR_HIDDEN_PLACEHOLDER)
                          .onAppear { lockOrientation() }
                  }
              }
              private func lockOrientation() {
                  guard let scene = UIApplication.shared.connectedScenes.first as? UIWindowScene else { return }
                  let prefs = UIWindowScene.GeometryPreferences.iOS(interfaceOrientations: ORIENTATION_PLACEHOLDER)
                  scene.requestGeometryUpdate(prefs) { _ in }
              }
          }
          struct WrappedWebView: UIViewRepresentable {
              func makeUIView(context: Context) -> WKWebView {
                  let config = WKWebViewConfiguration()
                  let prefs = WKWebpagePreferences()
                  prefs.allowsContentJavaScript = JS_ENABLED_PLACEHOLDER
                  config.defaultWebpagePreferences = prefs
                  config.allowsInlineMediaPlayback = true
                  config.mediaTypesRequiringUserActionForPlayback = []
                  let webView = WKWebView(frame: .zero, configuration: config)
                  webView.allowsBackForwardNavigationGestures = true
                  let ua = "USER_AGENT_PLACEHOLDER"
                  if !ua.isEmpty { webView.customUserAgent = ua }
                  if let url = URL(string: "SITE_URL_PLACEHOLDER") {
                      webView.load(URLRequest(url: url))
                  }
                  return webView
              }
              func updateUIView(_ uiView: WKWebView, context: Context) {}
          }
          SWIFTEOF

          # substitute placeholders
          sed -i '' "s|ORIENTATION_PLACEHOLDER|${ORIENTATION_MASK}|g" SiteWrapper/SiteWrapperApp.swift
          sed -i '' "s|IGNORE_SAFE_AREA_PLACEHOLDER|${IGNORE_SAFE_AREA}|g" SiteWrapper/SiteWrapperApp.swift
          sed -i '' "s|STATUS_BAR_HIDDEN_PLACEHOLDER|${STATUS_BAR_HIDDEN}|g" SiteWrapper/SiteWrapperApp.swift
          sed -i '' "s|JS_ENABLED_PLACEHOLDER|${{ inputs.enable_javascript }}|g" SiteWrapper/SiteWrapperApp.swift
          sed -i '' "s|USER_AGENT_PLACEHOLDER|${{ inputs.user_agent }}|g" SiteWrapper/SiteWrapperApp.swift
          sed -i '' "s|SITE_URL_PLACEHOLDER|${{ inputs.site_url }}|g" SiteWrapper/SiteWrapperApp.swift

          # write info.plist
          cat > SiteWrapper/Info.plist << PLISTEOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>NSAppTransportSecurity</key>
            <dict><key>NSAllowsArbitraryLoads</key><true/></dict>
            <key>UISupportedInterfaceOrientations</key>
            <array>
              <string>UIInterfaceOrientationPortrait</string>
              <string>UIInterfaceOrientationLandscapeLeft</string>
              <string>UIInterfaceOrientationLandscapeRight</string>
              <string>UIInterfaceOrientationPortraitUpsideDown</string>
            </array>
          </dict>
          </plist>
          PLISTEOF

          # write xcodegen project spec
          cat > site-project.yml << YMLEOF
          name: SiteWrapper
          options:
            bundleIdPrefix: com.beryllium
            deploymentTarget:
              iOS: "16.0"
          targets:
            SiteWrapper:
              type: application
              platform: iOS
              sources:
                - path: SiteWrapper
              settings:
                base:
                  PRODUCT_BUNDLE_IDENTIFIER: ${{ steps.ids.outputs.bundle_id }}
                  INFOPLIST_FILE: SiteWrapper/Info.plist
                  GENERATE_INFOPLIST_FILE: true
                  ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
                  CODE_SIGN_STYLE: Automatic
                  CURRENT_PROJECT_VERSION: 1
                  MARKETING_VERSION: "1.0"
                  INFOPLIST_KEY_CFBundleDisplayName: "${{ inputs.site_name }}"
                  INFOPLIST_KEY_UIApplicationSceneManifest_Generation: true
                  INFOPLIST_KEY_UILaunchScreen_Generation: true
                  SWIFT_VERSION: "5.0"
                  TARGETED_DEVICE_FAMILY: "1,2"
          YMLEOF

          # generate the xcode project
          xcodegen generate --spec site-project.yml
          echo "project generated:"
          xcodebuild -project SiteWrapper.xcodeproj -list

      # build the wrapper app
      - name: build archive
        run: |
          xcodebuild archive \
            -project SiteWrapper.xcodeproj \
            -scheme SiteWrapper \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/SiteWrapper.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES

      # package into an ipa
      - name: package ipa
        run: |
          mkdir -p build/Payload
          cp -r build/SiteWrapper.xcarchive/Products/Applications/SiteWrapper.app build/Payload/
          cd build
          zip -r -9 "${{ steps.ids.outputs.safe_name }}.ipa" Payload/
          echo "ipa size: $(du -h "${{ steps.ids.outputs.safe_name }}.ipa" | cut -f1)"

      - name: upload ipa artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ inputs.site_name }}-ipa"
          path: "build/${{ steps.ids.outputs.safe_name }}.ipa"
          if-no-files-found: error
          retention-days: 90
